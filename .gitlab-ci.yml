stages:
  - checks
  - versioning
  - container_build
  - retag
  - push
  - clean_up
  - deploy

clippy:
  stage: checks
  image: rust:1.76.0
  script:
    - rustup toolchain install nightly-2023-12-11-x86_64-unknown-linux-gnu
    - rustup default nightly-2023-12-11-x86_64-unknown-linux-gnu
    - rustup component add clippy
    - cargo clippy --all-targets --all-features -- -Dwarnings
  tags:
    - docker

versioning and prepare:
  stage: versioning
  script:
    - echo "Version is $CI_COMMIT_BRANCH.$CI_PIPELINE_ID"
  tags:
    - linux

build_solana:
  stage: container_build
  script:
    - docker build -t 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-solana:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID -t 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-solana:latest -f ./docker/Dockerfile_solana .
  tags:
    - linux


build_module:
  stage: container_build
  script:
    - docker build -t 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID -t 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:latest -f ./docker/Dockerfile_module .
  tags:
    - linux

retag:
  stage: retag
  script:
    - docker tag 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.latest
  only:
    - test-stand
  tags:
    - linux

solana_push:
  stage: push
  script:
    - docker push 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-solana:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID
    - docker push 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-solana:latest
  tags:
    - linux


module_push:
  stage: push
  script:
    - docker push 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID
    - docker push 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:latest
  tags:
    - linux

module_testnet:
  stage: push
  script:
    - docker push 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.latest
    - docker rmi 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.latest
  only:
    - test-stand
  tags:
    - linux

clean_up_images:
  stage: clean_up
  script:
    - docker rmi 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-solana:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID -f
    - docker rmi 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-solana:latest || true
    - docker rmi 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:$CI_COMMIT_BRANCH.$CI_PIPELINE_ID -f
    - docker rmi 899260217834.dkr.ecr.us-east-1.amazonaws.com/photon-module:latest || true
  tags:
    - linux

